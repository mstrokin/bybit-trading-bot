<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Farm Status Dashboard</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f4f4f4;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .latest {
        background-color: #e8f5e8;
      }
      .totals {
        background-color: #f0f8ff;
      }
      .actions {
        background-color: #fff3cd;
      }
      h2 {
        color: #333;
      }
      .stat {
        margin: 5px 0;
      }
      .label {
        font-weight: bold;
        color: #555;
      }
      .value {
        color: #007bff;
      }
      #lastUpdate {
        font-size: 0.9em;
        color: #888;
      }
      .loading {
        color: #888;
      }
      .error {
        color: #dc3545;
      }
      .symbol-div {
        margin-bottom: 10px;
      }
      button {
        margin-right: 5px;
        padding: 5px 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        color: white;
      }
      .pump-btn {
        background-color: #28a745;
      }
      .dump-btn {
        background-color: #dc3545;
      }
      #action-status {
        margin-top: 10px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Farm Status Dashboard</h1>
      <div id="lastUpdate">Last updated: Never</div>

      <div id="latest-section" class="section latest" style="display: none">
        <h2>Latest Update</h2>
        <div class="stat">
          <span class="label">Symbol:</span>
          <span id="latest-symbol" class="value"></span>
        </div>
        <div class="stat">
          <span class="label">Running Bots:</span>
          <span id="latest-bots" class="value"></span>
        </div>
        <div class="stat">
          <span class="label">Trading Balance:</span>
          <span id="latest-tradingBalance" class="value"></span> USDT
        </div>
        <div class="stat">
          <span class="label">Profit:</span>
          <span id="latest-profit" class="value"></span> USDT
        </div>
        <div class="stat">
          <span class="label">Account Size:</span>
          <span id="latest-accountSize" class="value"></span> USDT
        </div>
      </div>

      <div id="totals-section" class="section totals" style="display: none">
        <h2>Overall Totals</h2>
        <div class="stat">
          <span class="label">Total Sales:</span>
          <span id="total-sales" class="value"></span>
        </div>
        <div class="stat">
          <span class="label">Total Bot Profit:</span>
          <span id="total-botProfit" class="value"></span> USDT
        </div>
      </div>

      <div id="actions-section" class="section actions" style="display: none">
        <h2>Actions</h2>
        <div id="symbols-list"></div>
        <div id="action-status"></div>
      </div>

      <div
        id="error-section"
        class="section"
        style="display: none; background-color: #fff5f5; border-color: #f8d7da"
      >
        <h2>Error</h2>
        <div id="error-message" class="error"></div>
      </div>

      <div id="loading" class="loading">Loading...</div>
    </div>

    <script>
      const API_URL = "/api/status";
      const SYMBOLS_API = "/api/symbols";
      const ACTION_API = "/api/action";
      const UPDATE_INTERVAL = 2000; // 2 seconds

      async function loadSymbols() {
        try {
          const response = await fetch(SYMBOLS_API);
          const symbols = await response.json();
          const symbolsList = document.getElementById("symbols-list");
          symbolsList.innerHTML = "";
          symbols.forEach((symbol) => {
            const symbolDiv = document.createElement("div");
            symbolDiv.className = "symbol-div";
            symbolDiv.innerHTML = `
                        <span class="label">${symbol}:</span>
                        <button class="pump-btn" onclick="performAction('pump', '${symbol}')">Pump It</button>
                        <button class="dump-btn" onclick="performAction('dump', '${symbol}')">Dump It</button>
                    `;
            symbolsList.appendChild(symbolDiv);
          });
          document.getElementById("actions-section").style.display = "block";
        } catch (error) {
          console.error("Error loading symbols:", error);
        }
      }

      async function performAction(action, symbol) {
        const statusEl = document.getElementById("action-status");
        statusEl.textContent = `Performing ${action} for ${symbol}...`;
        statusEl.style.color = "#007bff";

        try {
          const response = await fetch(ACTION_API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action, symbol }),
          });
          const result = await response.json();

          if (result.success) {
            statusEl.textContent = result.message;
            statusEl.style.color = "#28a745";
            updateStatus();
          } else {
            statusEl.textContent = result.error || "Action failed.";
            statusEl.style.color = "#dc3545";
          }
        } catch (error) {
          statusEl.textContent = "Error performing action: " + error.message;
          statusEl.style.color = "#dc3545";
        }
      }

      function updateStatus() {
        fetch(API_URL)
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("loading").style.display = "none";

            if (data.error) {
              document.getElementById("error-section").style.display = "block";
              document.getElementById("error-message").textContent = data.error;
              document.getElementById("latest-section").style.display = "none";
              document.getElementById("totals-section").style.display = "none";
              return;
            }

            // Update latest
            if (data.latest) {
              document.getElementById("latest-section").style.display = "block";
              document.getElementById("latest-symbol").textContent =
                data.latest.symbol;
              document.getElementById("latest-bots").textContent =
                data.latest.bots;
              document.getElementById("latest-tradingBalance").textContent =
                Number(data.latest.tradingBalance).toFixed(2);
              document.getElementById("latest-profit").textContent = Number(
                data.latest.profit
              ).toFixed(2);
              document.getElementById("latest-accountSize").textContent =
                Number(data.latest.accountSize).toFixed(2);
            } else {
              document.getElementById("latest-section").style.display = "none";
            }

            // Update totals
            document.getElementById("totals-section").style.display = "block";
            document.getElementById("total-sales").textContent =
              data.totals.totalSales;
            document.getElementById("total-botProfit").textContent =
              data.totals.totalBotProfit;

            document.getElementById("error-section").style.display = "none";

            // Update timestamp
            document.getElementById(
              "lastUpdate"
            ).textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
          })
          .catch((error) => {
            console.error("Error fetching status:", error);
            document.getElementById("loading").style.display = "none";
            document.getElementById("error-section").style.display = "block";
            document.getElementById("error-message").textContent =
              "Failed to fetch status: " + error.message;
            document.getElementById("latest-section").style.display = "none";
            document.getElementById("totals-section").style.display = "none";
          });
      }

      // Initial load
      loadSymbols();
      updateStatus();

      // Set interval for updates
      setInterval(updateStatus, UPDATE_INTERVAL);
    </script>
  </body>
</html>
